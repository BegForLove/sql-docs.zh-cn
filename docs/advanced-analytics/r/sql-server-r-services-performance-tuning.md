---
title: SQL Server R Services 性能优化
ms.prod: sql
ms.technology: machine-learning
ms.date: 04/15/2018
ms.topic: conceptual
author: dphansen
ms.author: davidph
monikerRange: '>=sql-server-2016||>=sql-server-linux-ver15||=sqlallproducts-allversions'
ms.openlocfilehash: dd12e38e0d1f01cd142cc4c11efe43346dd1f8ce
ms.sourcegitcommit: 321497065ecd7ecde9bff378464db8da426e9e14
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/01/2019
ms.locfileid: "68715623"
---
# <a name="performance-tuning-for-r-in-sql-server"></a>SQL Server 中的 R 性能优化
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]

本文是一系列四篇文章中的第一篇文章, 这些文章基于两种案例研究介绍 R Services 的性能优化:

- 产品开发团队为验证 R 解决方案的性能配置文件而执行的性能测试

- 由 Microsoft 数据科学团队为经常请求的特定机器学习方案优化性能。

本系列的目的是提供有关在 SQL Server 中运行 R 作业最有用的性能优化技术类型的指导。

+ 本主题概述了对数据科学任务进行优化时的体系结构和一些常见问题。
+ 第二篇文章介绍了具体的硬件和 SQL Server 优化。
+ 第三篇文章介绍了操作化的 R 代码和资源中的优化。
+ 第四篇文章详细介绍了测试方法, 并报告了结果和结论。

**适用范围：** SQL Server 2016 R Services SQL Server 机器学习服务

## <a name="performance-goals-and-targeted-scenarios"></a>性能目标和目标方案

R Services 功能在 SQL Server 2016 中引入, 支持按 SQL Server 执行 R 脚本。 使用此功能时, R 运行时在独立于数据库引擎的进程中运行, 但使用服务器资源和与 SQL Server 交互的服务 (如受信任的快速启动) 与数据库引擎安全地交换数据。

在 SQL Server 2017 中, 公布了有关使用相同体系结构运行 Python 脚本的支持, 以及将来要遵循的其他语言。

随着受支持的版本和语言的增加, 数据库管理员和数据库架构师了解计算机学习作业可能发生资源争用, 并使服务器能够将服务器配置为支持新的工作负荷。 尽管保持接近数据的分析消除不安全的数据移动, 但它还会将分析工作负荷移出数据科学家的便携式计算机, 并返回到承载数据的服务器。

计算机学习的性能优化无疑不只是一种适合所有工作的情况。 以下常见任务可能具有不同的性能配置文件:

- 定型任务: 创建和定型回归模型与定型神经网络
- 使用 R 与功能的工程使用 T-sql 提取
- 使用表格输入对单个行或小型批处理进行评分, 使用大容量计分
- 在 R 和中运行评分与将模型部署到存储过程中 SQL Server 的生产
- 修改 R 代码以最大程度地减少数据传输或删除成本高昂的数据转换
- 启用模型的自动测试和重新定型

因为优化方法的选择取决于对应用程序或用例至关重要的任务, 案例研究涵盖了一般的性能提示, 并提供有关如何针对特定方案进行优化的指导, 以及批处理评分的优化。

+ **SQL Server 中的各个优化选项**

    在第一次性能案例研究中, 使用单一类型的模型对单个数据集运行多个测试。 RevoscaleR 中的 rxLinMod 算法用于生成模型并从其创建分数, 但代码和基础数据表被系统地更改, 以测试每个更改的影响。

    例如, 在一次测试运行中, R 代码发生了更改, 因此可以使用转换函数与预计算功能, 然后从表加载功能之间进行比较。 在另一次测试运行中, 在使用标准索引表与具有各种类型的压缩或新索引类型的表中的数据之间进行比较。

+ **针对特定大容量计分方案的优化**

    第二种案例研究中的机器学习任务涉及处理多个位置提交的多个简历, 并为每个作业位置寻找最佳候选项。 机器学习模型本身被表述为二元分类问题: 它会将恢复和作业说明作为输入, 并生成每个恢复作业对的概率。 由于目标是找出最佳匹配项, 因此, 用户定义的概率阈值用于进一步筛选和获取良好的匹配项。

    对于此解决方案, 主要目标是在评分过程中实现低延迟。 但是, 即使在评分过程中, 此任务也会计算成本高昂, 因为在合理的时间范围内, 每个新作业都必须与数百万个简历匹配。 此外, 此功能工程步骤每个简历或作业产生超过2000的功能, 这是一个明显的性能瓶颈。

建议你查看第一次案例研究中的所有结果, 以确定适用于你的解决方案的技术, 并权衡其潜在影响。

然后, 查看评分优化案例研究的结果, 了解作者如何应用不同的技术和优化服务器, 以支持特定的工作负载。

## <a name="performance-optimization-process"></a>性能优化过程

性能的配置和优化需要创建一个坚实的基础, 以便对特定工作负荷的优化进行分层:

- 选择适当的服务器以托管分析。 通常, 建议使用报表辅助数据库、数据仓库或其他已用于其他报表或分析的服务器。 但是, 在混合事务分析处理 (HTAP) 解决方案中, 可以将操作数据用作 R 的输入以实现快速评分。

- 配置 SQL Server 实例, 以在适当的级别平衡数据库引擎操作和 R 或 Python 脚本的执行情况。 这可能包括更改内存和 CPU 使用率的 SQL Server 默认值、NUMA 和处理器关联设置, 以及创建资源组。

- 优化服务器计算机以支持高效使用外部脚本。 这可能包括增加用于外部脚本执行的帐户数, 启用包管理并将用户分配到相关的安全角色。

- 在 SQL Server 中应用特定于数据存储和传输的优化, 包括索引和统计策略、查询设计和查询优化, 以及用于机器学习的表的设计。 你还可以分析数据源和数据传输方法, 或修改 ETL 进程以优化功能提取。

- 优化分析模型以避免效率低下。 可能的优化范围取决于 R 代码的复杂性以及所使用的包和数据。 关键任务包括消除成本高昂的数据转换, 或者将 R 或 Python 中的数据准备或功能设计任务卸载到 ETL 过程或 SQL 中。 您还可以重构脚本, 消除行内包安装, 将 R 代码划分为单独的过程, 以便进行定型、评分和评估, 或者简化代码以更高效地工作为存储过程。

## <a name="articles-in-this-series"></a>本系列文章

+ [SQL Server 硬件中的 R 性能优化](../r/sql-server-configuration-r-services.md)

    提供有关配置安装在上的[!INCLUDE[ssNoVersion_md](../../includes/ssnoversion-md.md)]硬件, 以及配置 SQL Server 实例以更好地支持外部脚本的指南。 它对于**数据库管理员**特别有用。

+ [SQL Server 代码和数据优化中的 R 性能优化](../r/r-and-data-optimization-r-services.md)

    提供有关如何优化外部脚本以避免已知问题的特定提示。 它最适用于**数据科学家**。

    > [!NOTE]
    > 虽然本部分中的大部分信息都适用于 R, 但某些信息是特定于 RevoScaleR 分析函数的。 详细的性能指南不适用于**revoscalepy**和其他受支持的 Python 库。
    >

+ [SQL Server 中的 R 性能优化-方法和结果](../r/performance-case-study-r-services.md)

    汇总了两种案例研究、如何测试性能以及优化影响结果的方式。
